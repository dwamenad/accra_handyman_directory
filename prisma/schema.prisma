generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum Role {
  CUSTOMER
  HANDYMAN
  ADMIN
}

enum ListingStatus {
  DRAFT
  PENDING
  APPROVED
  SUSPENDED
}

enum EventType {
  PROFILE_VIEW
  WHATSAPP_CLICK
  CALL_CLICK
}

model User {
  id              String   @id @default(cuid())
  name            String
  phone           String   @unique
  email           String?  @unique
  passwordHash    String
  role            Role
  phoneVerified   Boolean  @default(false)
  suspended       Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  handymanProfile HandymanProfile?
  reviews         Review[] @relation("ReviewAuthor")
}

model HandymanProfile {
  id                     String   @id @default(cuid())
  userId                 String   @unique
  slug                   String   @unique
  businessName           String
  about                  String?
  areasText              String?
  weeklyAvailabilityJson String?
  acceptsBookings        Boolean  @default(false)
  paymentMethods         String?
  requestQuoteEnabled    Boolean  @default(true)
  publicPhone            String
  listingStatus          ListingStatus @default(DRAFT)
  profileCompleteness    Int      @default(0)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  user             User @relation(fields: [userId], references: [id])
  trades           HandymanTrade[]
  services         HandymanService[]
  pricingItems     PricingItem[]
  photos           Photo[]
  reviews          Review[]
  verification     VerificationStatus?
  analyticsEvents  AnalyticsEvent[]
}

model TradeCategory {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())

  serviceTypes  ServiceType[]
  handymanLinks HandymanTrade[]
}

model ServiceType {
  id        String   @id @default(cuid())
  tradeId   String
  name      String
  createdAt DateTime @default(now())

  trade      TradeCategory @relation(fields: [tradeId], references: [id])
  pricing    PricingItem[]
  handymanServices HandymanService[]
  reviews    Review[]

  @@unique([tradeId, name])
}

model Area {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())

  reviews Review[]
}

model HandymanTrade {
  id         String @id @default(cuid())
  profileId  String
  tradeId    String

  profile HandymanProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  trade   TradeCategory @relation(fields: [tradeId], references: [id])

  @@unique([profileId, tradeId])
}

model HandymanService {
  id            String @id @default(cuid())
  profileId      String
  serviceTypeId  String
  notes          String?

  profile     HandymanProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  serviceType ServiceType @relation(fields: [serviceTypeId], references: [id])

  @@unique([profileId, serviceTypeId])
}

model PricingItem {
  id            String   @id @default(cuid())
  profileId      String
  serviceTypeId  String
  minPrice       Int?
  maxPrice       Int?
  notes          String?

  profile     HandymanProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  serviceType ServiceType @relation(fields: [serviceTypeId], references: [id])
}

model Photo {
  id         String   @id @default(cuid())
  profileId   String
  url         String
  caption     String?
  createdAt   DateTime @default(now())

  profile HandymanProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
}

model Review {
  id             String   @id @default(cuid())
  customerId      String
  handymanProfileId String
  serviceTypeId   String?
  areaId          String?
  rating          Int
  tagsCsv         String
  text            String?
  createdAt       DateTime @default(now())
  removedByAdmin  Boolean @default(false)

  customer  User @relation("ReviewAuthor", fields: [customerId], references: [id])
  profile   HandymanProfile @relation(fields: [handymanProfileId], references: [id], onDelete: Cascade)
  serviceType ServiceType? @relation(fields: [serviceTypeId], references: [id])
  area      Area? @relation(fields: [areaId], references: [id])

  @@index([handymanProfileId, createdAt])
}

model VerificationStatus {
  id                    String @id @default(cuid())
  handymanProfileId      String @unique
  phoneVerifiedBadge     Boolean @default(false)
  idVerifiedBadge        Boolean @default(false)
  verifiedWorkBadge      Boolean @default(false)

  profile HandymanProfile @relation(fields: [handymanProfileId], references: [id], onDelete: Cascade)
}

model AnalyticsEvent {
  id               String   @id @default(cuid())
  handymanProfileId String
  eventType        EventType
  createdAt        DateTime @default(now())

  profile HandymanProfile @relation(fields: [handymanProfileId], references: [id], onDelete: Cascade)

  @@index([handymanProfileId, eventType])
}
